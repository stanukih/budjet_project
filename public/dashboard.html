<!DOCTYPE html>
<html lang="fi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Tapahtumat</title>
</head>

<body>
    <header>
        <a href="home.html" class="btn">Etusivu</a>
        <div style="display: flex;">
            <a href="logout.html" class="btn">Kirjaudu ulos</a>
        </div>
    </header>

    <div class="content">
        <div class="container">
            <h2>Tapahtumat</h2>
            <div class="horizontal-container">
                <a href="operation_create.html" class="btn">Lisää uusi tapahtuma</a>
                <a href="accounts.html" class="btn">Selaa tilejä</a>
            </div>
            <br>
            <form class="horizontal-container">
                <h4>Suodattimet:</h4>
                <div>
                    <label>Ajanjakso:</label><br>
                    <input type="date" name="filter-date-start" id="filter-date-start"><br>
                    <input type="date" name="filter-date-end" id="filter-date-end">
                </div>
                <div>
                    <label>Rahamäärä:</label><br>
                    <select name="filter-operation" id="filter-operation">
                        <option value="none">-</option>
                        <option value=">">&gt;</option>
                        <option value=">=">&gt;=</option>
                        <option value="=">=</option>
                        <option value="<=">=&lt;</option>
                        <option value="<">&lt;</option>
                    </select>
                    <input type="number" step=".01" name="filter-sum" id="filter-sum">
                </div>
                <div>
                    <label>Tyyppi:</label><br>
                    <select name="filter-type" id="filter-type">
                        <option value="all">Kaikki</option>
                        <option value="coming">Tulot</option>
                        <option value="going">Menot</option>
                    </select>
                </div>
                <div>
                    <label>Kategoria:</label><br>
                    <select name="filter-category" id="filter-category">
                        <option value="">Kaikki kategoriat</option>
                    </select>
                </div>
                <button class="btn" type="button" id="filter-search">Hae</button>
            </form>
            <hr>

            <div style="overflow-y: auto; max-height: 475px; width: fit-content ;">
                <table id="results-table">
                    <th>Päivämäärä</th>
                    <th>Rahamäärä</th>
                    <th>Tili</th>
                    <th>Kategoria</th>
                    <th>Kuvaus</th>
                    <th>Toiminnot</th>
                </table>
            </div>

            <hr>

            <div class="horizontal-container">
                <div class="summary-container">
                    <h4>Kuukausiyhteenveto</h4>
                    <p id="netBudgetMonthly"></p>
                    <table id="categ-graph-monthly" class="categ-graph">
                    </table>
                </div>

                <div class="summary-container">
                    <h4>Vuoden yhteenveto</h4>
                    <p id="netBudgetYear"></p>
                    <table id="categ-graph-year" class="categ-graph">
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>

        if (localStorage.getItem("user") == null) {
            window.location.replace("login.html");
        }

        const categorySelect = document.getElementById("filter-category");

        let categories;

        fetch("api/category/get_all")
            .then((response) => response.json())
            .then((json) => {

                if (json.status == "success") {

                    categories = json.data;
                    for (let i = 0; i < json.data.length; i++) {

                        let opt = document.createElement("option");

                        const categ = json.data[i];
                        opt.value = categ.id;
                        opt.innerHTML = categ.title;

                        categorySelect.appendChild(opt);
                    }

                }
            });


        let accounts;
        fetch("api/account/get_all?user_id=" + localStorage.user)
            .then((response) => response.json())
            .then((json) => {
                if (json.status == "success") {
                    accounts = json.data;
                    search();
                }
            });



        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        let month_sums = [];
        let month_categs = [];
        let month_types = [];

        let year_sums = [];
        let year_categs = [];
        let year_types = [];


        document.getElementById("filter-search").addEventListener("click", search);
        function search() {

            const resultTable = document.getElementById("results-table");
            resultTable.innerHTML = "<th>Päivämäärä</th><th>Rahamäärä</th><th>Tili</th><th>Kategoria</th><th>Kuvaus</th><th>Toiminnot</th>";


            const filter_dateStart = document.getElementById("filter-date-start");
            const filter_dateEnd = document.getElementById("filter-date-end");
            const filter_operation = document.getElementById("filter-operation");
            const filter_sum = document.getElementById("filter-sum");
            const filter_category = document.getElementById("filter-category");
            const filter_type = document.getElementById("filter-type");

            if (filter_dateStart.checkValidity() && filter_dateEnd.checkValidity() && filter_sum.checkValidity()) {

                if ((filter_operation.value === "none" && filter_sum.value !== "") || (filter_operation.value !== "none" && filter_sum.value === "")) {

                    filter_operation.value = "none";
                    filter_sum.value = "";
                }

                fetch("api/operation/get_all", {
                    method: "POST",
                    body: JSON.stringify({
                        user_id: localStorage.getItem("user"),
                        filter: {
                            start_date: filter_dateStart.value,
                            end_date: filter_dateEnd.value,
                            sum: {
                                operation: filter_operation.value,
                                value: filter_sum.value
                            },
                            category_id: filter_category.value
                        }
                    }
                    ),

                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json.status == "success") {

                            const resultTable = document.getElementById("results-table");

                            for (let i = 0; i < json.data.length; i++) {
                                const opr = json.data[i];

                                if ((filter_type.value === "coming" && opr.type === "going") || (filter_type.value === "going" && opr.type === "coming")) {
                                    continue;
                                }

                                const tr = document.createElement("tr");

                                const td1 = document.createElement("td");
                                td1.textContent = opr.created_at.substring(0, 10);
                                tr.appendChild(td1);

                                const td2 = document.createElement("td");
                                td2.textContent = opr.sum;
                                if (opr.type === "going") { td2.className = "opr-going"; }
                                else if (opr.type === "coming") { td2.className = "opr-coming"; }
                                tr.appendChild(td2);

                                const td4 = document.createElement("td");
                                td4.textContent = accounts[accounts.findIndex(o => o.id === opr.account_id)].title;
                                tr.appendChild(td4);

                                const td3 = document.createElement("td");
                                td3.textContent = categories[categories.findIndex(o => o.id === opr.category_id)].title;
                                tr.appendChild(td3);

                                const td5 = document.createElement("td");
                                td5.textContent = opr.description;
                                tr.appendChild(td5);

                                const td6 = document.createElement("td");
                                td6.innerHTML = '<div class="horizontal-container"><a href="operation_update.html?operation_id=' + opr.id + '" class="btn">Muokkaa</a> <button class="btn" onclick="deleteOperation(\'' + opr.id + '\')">Poista</button> </div>';
                                tr.appendChild(td6);

                                resultTable.appendChild(tr);

                            }
                            listSummaries();
                        }
                    });
            }
        }

        function deleteOperation(id) {
            if (confirm("Haluatko varmasti poistaa tapahtuman?")) {
                if (id !== null) {
                    fetch("api/operation/delete", {
                        method: "DELETE",
                        body: JSON.stringify({
                            operation_id: id,
                            user_id: localStorage.getItem("user")
                        }),

                        headers: {
                            "Content-type": "application/json; charset=UTF-8"
                        }
                    }).then((response) => response.json())
                        .then((json) => {
                            if (json.status === 'error') {
                                console.log(json.message);
                            }
                            search();
                        });
                }
            }
        }



        function addMonthlyOperation(sum, type, categ, date) {
            if (date.substr(5, 2) == currentMonth + 1 && date.substr(0,4) == currentYear) {
                month_sums.push(parseFloat(sum));
                month_categs.push(categ);
                month_types.push(type);
            }
        }

        function addYearlyOperation(sum, type, categ, date) {
            if (date.substr(0, 4) == currentYear) {
                year_sums.push(parseFloat(sum));
                year_categs.push(categ);
                year_types.push(type);
            }
        }

        function listSummaries() {
            fetch("api/operation/get_all", {
                method: "POST",
                body: JSON.stringify({
                    user_id: localStorage.getItem("user")
                }),

                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json.status == "success") {
                        listMonthlySummary(json);
                        listYearSummary(json);
                    }
                }
                );
        }

        function listMonthlySummary(json) {
            month_sums.length = 0;
            month_categs.length = 0;
            month_types.length = 0;
            let netBudget = 0;

            for (let i = 0; i < json.data.length; i++) {
                const opr = json.data[i];

                addMonthlyOperation(opr.sum, opr.type, categories[categories.findIndex(o => o.id === opr.category_id)].title, opr.created_at)

            }

            const summaryText = document.getElementById("netBudgetMonthly");
            const summaryNum = document.createElement("span");

            for (let i = 0; i < month_sums.length; i++) {

                if (month_types[i] === "going") {
                    netBudget -= month_sums[i];
                }
                else if (month_types[i] === "coming") {
                    netBudget += month_sums[i];
                }
            }

            summaryText.textContent = "Kuukauden nettobudjetti: ";
            styleSummary(summaryNum, netBudget);
            summaryText.appendChild(summaryNum);


            const categList = document.getElementById("categ-graph-monthly");
            categList.innerHTML = "";

            let sums = [];
            let bars = [];

            categories.forEach(category => {
                const tr = document.createElement("tr");
                let categSum = 0;
                const td1 = document.createElement("td");
                const td2 = document.createElement("td");
                const sumBar1 = document.createElement("div");
                const sumBar2 = document.createElement("div");

                tr.style = "height: 60px;"
                td1.style = "border-right: 1px solid #000; max-width: 130px";
                td2.className = "categ-bar-container table-no-border";
                td1.className = "table-no-border";
                tr.className = "table-no-border";

                sumBar2.className = "categ-bar-filler";

                for (let i = 0; i < month_sums.length; i++) {
                    if (month_categs[i] === category.title) {

                        if (month_types[i] === "going") {
                            categSum -= month_sums[i];
                        }
                        else if (month_types[i] === "coming") {
                            categSum += month_sums[i];
                        }

                    }
                    td1.textContent = category.title;
                    sumBar1.textContent = categSum.toFixed(2) + "€";
                    if (categSum >= 0) {
                        sumBar1.className = "categ-bar-1";
                        td2.style = "flex-direction:row;";
                    } else {
                        sumBar1.className = "categ-bar-2";
                        td2.style = "flex-direction:row-reverse;";
                    }
                    td2.appendChild(sumBar2);
                    td2.appendChild(sumBar1);
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    categList.appendChild(tr);
                    sums.push(categSum);
                    bars.push(sumBar1);
                }
            });

            let highest = 0;

            for (let i = 0; i < sums.length; i++) {
                const num = Math.abs(sums[i]);
                if (Math.abs(num > highest)) {
                    highest = num;
                }
            }

            const ratio = 200 / highest;

            for (let i = 0; i < sums.length; i++) {
                bars[i].style = "width: " + (Math.abs(sums[i]) * ratio) + "px;";
            }

        }


        function listYearSummary(json) {
            year_sums.length = 0;
            year_categs.length = 0;
            year_types.length = 0;
            let netBudget = 0;

            for (let i = 0; i < json.data.length; i++) {
                const opr = json.data[i];

                addYearlyOperation(opr.sum, opr.type, categories[categories.findIndex(o => o.id === opr.category_id)].title, opr.created_at)

            }

            const summaryText = document.getElementById("netBudgetYear");
            const summaryNum = document.createElement("span");

            for (let i = 0; i < year_sums.length; i++) {

                if (year_types[i] === "going") {
                    netBudget -= year_sums[i];
                }
                else if (year_types[i] === "coming") {
                    netBudget += year_sums[i];
                }
            }

            summaryText.textContent = "Kuukauden nettobudjetti: ";
            styleSummary(summaryNum, netBudget);
            summaryText.appendChild(summaryNum);


            const categList = document.getElementById("categ-graph-year");
            categList.innerHTML = "";

            let sums = [];
            let bars = [];

            categories.forEach(category => {
                const tr = document.createElement("tr");
                let categSum = 0;
                const td1 = document.createElement("td");
                const td2 = document.createElement("td");
                const sumBar1 = document.createElement("div");
                const sumBar2 = document.createElement("div");

                tr.style = "height: 60px;"
                td1.style = "border-right: 1px solid #000; max-width: 130px";
                td2.className = "categ-bar-container table-no-border";
                td1.className = "table-no-border";
                tr.className = "table-no-border";

                sumBar2.className = "categ-bar-filler";

                for (let i = 0; i < year_sums.length; i++) {
                    if (year_categs[i] === category.title) {

                        if (year_types[i] === "going") {
                            categSum -= year_sums[i];
                        }
                        else if (year_types[i] === "coming") {
                            categSum += year_sums[i];
                        }

                    }
                    td1.textContent = category.title;
                    sumBar1.textContent = categSum.toFixed(2) + "€";
                    if (categSum >= 0) {
                        sumBar1.className = "categ-bar-1";
                        td2.style = "flex-direction:row;";
                    } else {
                        sumBar1.className = "categ-bar-2";
                        td2.style = "flex-direction:row-reverse;";
                    }
                    td2.appendChild(sumBar2);
                    td2.appendChild(sumBar1);
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    categList.appendChild(tr);
                    sums.push(categSum);
                    bars.push(sumBar1);
                }
            });

            let highest = 0;

            for (let i = 0; i < sums.length; i++) {
                const num = Math.abs(sums[i]);
                if (Math.abs(num > highest)) {
                    highest = num;
                }
            }

            const ratio = 200 / highest;

            for (let i = 0; i < sums.length; i++) {
                bars[i].style = "width: " + (Math.abs(sums[i]) * ratio) + "px;";
            }

        }



        function styleSummary(numElement, sum) {
            numElement.textContent = sum.toFixed(2) + " €";
            numElement.style = sum < 0 ? "color:var(--text-red);" : "color:var(--text-green);";
        }



    </script>

    <footer>
        <p>footer</p>
    </footer>
</body>

</html>